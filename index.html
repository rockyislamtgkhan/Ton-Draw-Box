<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ton Draw Box</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #4200ac, #00c3ff);
      color: white;
      text-align: center;
      overflow-x: hidden;
    }
    #loading {
      position: fixed;
      width: 100%;
      height: 100%;
      background: #1e004d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      z-index: 1000;
      flex-direction: column;
      animation: fadeOut 1s ease 2.5s forwards;
    }
    .dots::after {
      content: '';
      animation: dots 1.5s steps(3, end) infinite;
    }
    @keyframes dots {
      0% { content: ''; }
      33% { content: '.'; }
      66% { content: '..'; }
      100% { content: '...'; }
    }
    @keyframes fadeOut {
      to { opacity: 0; visibility: hidden; }
    }
    .container {
      padding: 20px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .box-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 20px;
      justify-items: center;
    }
    .box-img {
      width: 100px;
      height: 100px;
      object-fit: contain;
      cursor: pointer;
    }
    .balance-info {
      font-size: 18px;
      margin-bottom: 10px;
    }
    .btn {
      background: gold;
      color: black;
      border: none;
      padding: 12px 20px;
      margin: 8px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 5px 12px rgba(0,0,0,0.3);
    }
    .popup {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      color: black;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      display: none;
      z-index: 9999;
      text-align: center;
      max-width: 320px;
    }
    #user-info {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      align-items: center;
      color: white;
      font-weight: bold;
    }
    #user-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div id="loading">
   ‚è≥<span>Ton Draw Box Loading<span class="dots"></span></span>
  </div>

  <div id="user-info"></div>

  <div class="container">
    <h1>WELCOME</h1>
    <div class="balance-info">
      Prize Pool: <span id="prize">0.00 TON</span><br>
      Your Balance: <span id="balance">0.00 TON</span>
    </div>

    <div class="box-grid">
      <img src="assets/box1.png" class="box-img" onclick="buyBox(1)">
      <img src="assets/box2.png" class="box-img" onclick="buyBox(2)">
      <img src="assets/box3.png" class="box-img" onclick="buyBox(3)">
      <img src="assets/box4.png" class="box-img" onclick="buyBox(4)">
      <img src="assets/box5.png" class="box-img" onclick="buyBox(5)">
      <img src="assets/box6.png" class="box-img" onclick="buyBox(6)">
    </div>

    <div>
      <button class="btn" onclick="openDeposit()">üí∞ Deposit</button>
      <button class="btn" onclick="openWithdraw()">üì§ Withdraw</button>
      <button class="btn" onclick="showInvite()">üì® Invite</button>
      <button class="btn" onclick="window.open('https://t.me/TonDrawBoxOfficial', '_blank')">üì¢ Channel</button>
    </div>
  </div>

  <div id="popup" class="popup"></div>

  <script>
    const popup = document.getElementById('popup');
    let userBalance = 0.00;
    let prizePool = 0.00;
    let userWallet = "";

    function update() {
      document.getElementById('balance').textContent = userBalance.toFixed(2) + " TON";
      document.getElementById('prize').textContent = prizePool.toFixed(2) + " TON";
      localStorage.setItem('balance', userBalance);
    }

    async function fetchRealBalance() {
      const userId = Telegram.WebApp.initDataUnsafe?.user?.id;
      if (!userId) return;
      try {
        const res = await fetch(`https://ton-draw-box.onrender.com/balances.json`);
        const data = await res.json();
        if (data[userId]) {
          userBalance = parseFloat(data[userId]);
          update();
        }
      } catch (e) {
        console.error("Failed to fetch real balance:", e);
      }
    }

    function showPopup(content) {
      popup.innerHTML = content + `<br><button class='btn btn-close' onclick='closePopup()'>‚ùå Close</button>`;
      popup.style.display = 'block';
    }

    function closePopup() {
      popup.style.display = 'none';
    }

    function buyBox(num) {
      if (userBalance >= 0.2) {
        userBalance -= 0.2;
        prizePool += 0.2;
        update();

        fetch("https://ton-draw-box.onrender.com/draw-result")
          .then(res => res.json())
          .then(data => {
            const { winningBox, winners, prize } = data;
            const userId = Telegram.WebApp.initDataUnsafe?.user?.id;

            const isWinner = (winningBox === num) && winners.includes(String(userId));
            const reward = isWinner ? prize : 0;

            if (isWinner) {
              userBalance += reward;
              update();
              showPopup(`üéâ You picked Box ${num} and WON ${reward} TON!`);
            } else {
              showPopup(`üò¢ You picked Box ${num}, but it didn‚Äôt win.`);
            }
          })
          .catch(err => {
            console.error("Error fetching result:", err);
            showPopup("‚ö†Ô∏è Error fetching draw result. Try again.");
          });

      } else {
        showPopup(" Insufficient Balance!");
      }
    }

    function openDeposit() {
      showPopup(`
        <h3>Select Deposit</h3>
        <button class='btn' onclick='confirmDeposit(1)'>ü™ô 1 TON</button>
        <button class='btn' onclick='confirmDeposit(2)'>ü™ô 2 TON</button>
        <button class='btn' onclick='confirmDeposit(5)'>ü™ô 5 TON</button>
        <button class='btn' onclick='confirmDeposit(10)'>ü™ô 10 TON</button>
      `);
    }

    function confirmDeposit(amount) {
      const tonAddress = "UQDPCzsr3SEjPT24JTrwB80v55quJPUNUmqvyADtPfPm8tNv";
      const nanoAmount = amount * 1e9;
      const userId = Telegram.WebApp.initDataUnsafe?.user?.id || "unknown";
      const comment = `UID${userId}_AMT${amount}`;
      const url = `https://app.tonkeeper.com/transfer/${tonAddress}?amount=${nanoAmount}&text=${comment}`;
      window.open(url, '_blank');
      closePopup();
    }

    function openWithdraw() {
      if (!userWallet) {
        showPopup(`
          <h3>Enter Wallet</h3>
          <input id='walletInput' placeholder='EQ...' style='width:100%; padding:8px;'>
          <br><br><button class='btn' onclick='setWallet()'>Set Wallet</button>
        `);
      } else {
        showPopup(`
          <h3>Withdraw Amount</h3>
          <button class='btn' onclick='requestWithdraw(1)'>1 TON</button>
          <button class='btn' onclick='requestWithdraw(2)'>2 TON</button>
          <button class='btn' onclick='requestWithdraw(5)'>5 TON</button>
          <button class='btn' onclick='requestWithdraw(10)'>10 TON</button>
        `);
      }
    }

    function setWallet() {
      const input = document.getElementById('walletInput');
      if (input.value) {
        userWallet = input.value;
        openWithdraw();
      } else alert("Enter valid address");
    }

    function requestWithdraw(amount) {
  const userId = Telegram.WebApp.initDataUnsafe?.user?.id || "unknown";
  const username = Telegram.WebApp.initDataUnsafe?.user?.username || "NoUsername";
  fetch("https://ton-draw-box.onrender.com/withdraw", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      userId,
      username,
      wallet: userWallet,
      amount
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showPopup(`‚úÖ Withdraw request of ${amount} TON to:<br><b>${userWallet}</b>`);
    } else {
      showPopup("‚ùå Failed to submit request");
    }
  })
  .catch(err => {
    console.error("Withdraw error:", err);
    showPopup("‚ùå Server error occurred");
  });
}
    function showInvite() {
      const id = Telegram.WebApp.initDataUnsafe?.user?.id || "123456789";
      const link = `https://t.me/TonDrawBoxBot?start=${id}`;
      showPopup(`
        <h3>üì® Invite & Earn</h3>
        <p><b>Your Referral:</b><br><input style='width:100%; padding:6px;' value='${link}' readonly onclick='this.select()'></p>
        <p>Earn 0.01 TON per real invite. ‚ùå Fake not allowed.</p>
      `);
    }

    window.onload = () => {
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
        const user = Telegram.WebApp.initDataUnsafe?.user;
        if (user) {
          document.getElementById("user-info").innerHTML = `
            <img src="${user.photo_url}" />
            <span>${user.first_name}</span>
          `;
        }
        fetchRealBalance();
      }, 2000);
      update();

      window.addEventListener("focus", () => {
        fetchRealBalance();
      });
    }
  </script>
</body>
</html>